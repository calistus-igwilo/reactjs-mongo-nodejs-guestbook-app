pipeline {
  agent {
    node {
      label 'host3-jenkins-dind-nodejs-slave'
    }
  }

  stages {
    stage ('Checkout Code') {
      steps {
        checkout scm
      }
    }
    stage ('Verify Tools'){
      steps {
        parallel (
          node: { sh "npm -v" },
          docker: { sh "docker -v" },
          artillery: { sh "artillery -V" }

        )
      }
    }
    stage('Unit Tests'){
      steps {
       sh 'cd guestbook-backend && npm install '
        sh 'cd guestbook-frontend && npm install '
      }
    }
    stage('Static Code Analysis'){
        environment {
            scannerHome = tool 'SonarQubeScanner'
        }
      steps {
            withSonarQubeEnv('Host-2-SonarQube') {
                sh "${scannerHome}/bin/sonar-scanner"
            }
            timeout(time: 1, unit: 'MINUTES') {
                waitForQualityGate abortPipeline: true
            }
      }
    }

    stage('Build Docker image'){
     steps{
        sh 'docker stop guestbook_app '
        sh 'docker rm guestbook_app'
        sh 'docker rmi guestbook:latest'
        sh 'cd guestbook-frontend && npm  run build'
        sh 'docker build -t guestbook .'
     }
    }
    stage('Run Docker container'){
     steps{
        sh 'docker run  -d --name guestbook_app -p 8080:8080 guestbook '
     }
    }

    stage('UI Tests'){
     /* Run Selenium test  */
      steps{
        sh 'cd guestbook-frontend && npm run seleniumtest'
      }
     }
    stage('Load Tests'){
     steps{
     /* Load tests */
      sh 'artillery quick --count 20 -n 20 http://127.0.0.1:8080/guests'
      sh 'artillery quick --count 20 -n 20 http://127.0.0.1:8080/login'

     }
    }
    stage('Publish Artifacts'){
     steps{
     /* Publish artifacts to Nexus private docker registry */
       sh ''
     }
    }
  }
}
                  sh 'ssh -o StrictHostKeyChecking=no -v devadmin@192.168.2.15 docker pull 192.168.2.11:8082/guestbook' + ":$BUILD_NUMBER"
